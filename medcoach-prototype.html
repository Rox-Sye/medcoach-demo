<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MedCoach - Dashboard Alpha</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; padding: 20px; }
    .container { background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 500px; width: 100%; padding: 30px; }
    h1 { text-align: center; color: #333; margin-bottom: 5px; }
    .subtitle { text-align: center; color: #666; font-size: 14px; margin-bottom: 25px; }

    /* Dashboard Stats */
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
    .stat-box { background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #eee; }
    .stat-box.full { grid-column: span 2; background: #eef2ff; border-color: #667eea; }
    .stat-label { font-size: 11px; text-transform: uppercase; color: #888; letter-spacing: 0.5px; margin-bottom: 5px; display: block; }
    .stat-value { font-size: 22px; font-weight: 700; color: #667eea; }
    .streak-val { color: #ff4757; }

    /* Form */
    .form-group { margin-bottom: 15px; position: relative; }
    label { display: block; margin-bottom: 6px; font-weight: 600; color: #444; font-size: 13px; }
    input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
    button { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
    .btn-main { background: #667eea; color: white; margin-top: 10px; }
    .btn-test { background: #f1f2f6; color: #667eea; font-size: 12px; margin-top: 10px; border: 1px dashed #667eea; }

    /* Suggestions */
    #suggestions { list-style: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 0 0 6px 6px; max-height: 180px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    #suggestions.active { display: block; }
    #suggestions li { padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 13px; }
    #suggestions li:hover { background: #f8f9fa; }

    /* List */
    .treatment-list { margin-top: 30px; }
    .item { background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 10px; margin-bottom: 12px; border-left: 5px solid #667eea; position: relative; }
    .item h4 { color: #333; margin-bottom: 4px; }
    .item p { font-size: 12px; color: #777; line-height: 1.4; }
    .actions { display: flex; gap: 8px; margin-top: 10px; }
    .btn-pris { background: #2ed573; color: white; padding: 6px 12px; font-size: 12px; width: auto; }
    .btn-del { background: #ff4757; color: white; padding: 6px 12px; font-size: 12px; width: auto; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üè• MedCoach</h1>
    <p class="subtitle">Alpha - Suivi Personnel</p>

    <div class="stats-grid">
      <div class="stat-box full">
        <span class="stat-label">üî• Streak Actuel</span>
        <div class="stat-value streak-val" id="streak">0 jours</div>
      </div>
      <div class="stat-box">
        <span class="stat-label">üìà Adh√©rence (7j)</span>
        <div class="stat-value" id="adh7">0%</div>
      </div>
      <div class="stat-box">
        <span class="stat-label">‚è∞ √Ä l'heure</span>
        <div class="stat-value" id="ontime">0%</div>
      </div>
    </div>

    <div class="form-group">
      <label>M√©dicament (BDPM)</label>
      <input id="medSearch" placeholder="Rechercher..." oninput="searchMed(this.value)">
      <ul id="suggestions"></ul>
    </div>

    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
      <div style="flex: 1;">
        <label>Quantit√©</label>
        <input id="qte" type="number" value="1" min="1">
      </div>
      <div style="flex: 1;">
        <label>Unit√©</label>
        <select id="unit">
          <option>comprim√©</option>
          <option>g√©lule</option>
          <option>ml</option>
          <option>sachet</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label>Moments (ex: matin, midi, soir)</label>
      <input id="moments" placeholder="matin, soir" value="matin">
    </div>

    <button class="btn-main" onclick="addTreatment()">Ajouter le traitement</button>
    <button class="btn-test" onclick="testIn10Min()">üîî Tester un rappel dans 10 min</button>

    <div class="treatment-list" id="list"></div>
  </div>

  <script>
    // 1. Initialisation & SW
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    let treatments = JSON.parse(localStorage.getItem('treatments')) || [];
    render();

    // 2. Autocomplete BDPM
    async function searchMed(q) {
      if (q.length < 3) return document.getElementById('suggestions').innerHTML = '';
      const r = await fetch(`https://api-medicaments.fr/medecines?name=${q}`);
      const data = await r.json();
      const s = document.getElementById('suggestions');
      s.innerHTML = '';
      data.slice(0, 10).forEach(m => {
        const li = document.createElement('li');
        li.textContent = m.name;
        li.onclick = () => {
          document.getElementById('medSearch').value = m.name;
          s.classList.remove('active');
        };
        s.appendChild(li);
      });
      s.classList.add('active');
    }

    // 3. Gestion Traitements
    function addTreatment() {
      const name = document.getElementById('medSearch').value;
      if (!name) return alert('Nom requis');
      
      const t = {
        id: Date.now(),
        name,
        qte: document.getElementById('qte').value,
        unit: document.getElementById('unit').value,
        moments: document.getElementById('moments').value.split(',').map(x => x.trim()),
        history: []
      };
      
      treatments.push(t);
      save();
      render();
      document.getElementById('medSearch').value = '';
    }

    function onPris(id) {
      const t = treatments.find(x => x.id === id);
      const now = new Date();
      // On consid√®re "√† l'heure" si pris avant 10h pour le matin
      const isLate = now.getHours() >= 10; 
      t.history.push({ date: now.toISOString(), isLate });
      save();
      render();
    }

    function remove(id) {
      treatments = treatments.filter(x => x.id !== id);
      save();
      render();
    }

    function save() {
      localStorage.setItem('treatments', JSON.stringify(treatments));
    }

    // 4. Stats & Rendu
    function render() {
      const list = document.getElementById('list');
      list.innerHTML = treatments.length ? '<h3>Mes Traitements</h3>' : '';
      
      treatments.forEach(t => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <h4>${t.name}</h4>
          <p>${t.qte} ${t.unit} ‚Ä¢ ${t.moments.join(', ')}</p>
          <div class="actions">
            <button class="btn-pris" onclick="onPris(${t.id})">Pris ‚úì</button>
            <button class="btn-del" onclick="remove(${t.id})">Suppr.</button>
          </div>
        `;
        list.appendChild(div);
      });
      
      updateStats();
    }

    function updateStats() {
      const hist = treatments.flatMap(t => t.history);
      if (!hist.length) return;

      // Adh√©rence 7j
      const dates = [...new Set(hist.map(h => h.date.split('T')[0]))];
      const last7 = [...Array(7)].map((_, i) => {
        const d = new Date(); d.setDate(d.getDate() - i);
        return d.toISOString().split('T')[0];
      });
      const hit = last7.filter(d => dates.includes(d)).length;
      document.getElementById('adh7').textContent = Math.round((hit/7)*100) + '%';

      // √Ä l'heure
      const ont = hist.filter(h => !h.isLate).length;
      document.getElementById('ontime').textContent = Math.round((ont/hist.length)*100) + '%';

      // Streak
      let streak = 0;
      let checkDate = new Date().toISOString().split('T')[0];
      while (dates.includes(checkDate)) {
        streak++;
        const d = new Date(checkDate);
        d.setDate(d.getDate() - 1);
        checkDate = d.toISOString().split('T')[0];
      }
      document.getElementById('streak').textContent = streak + ' jours';
    }

    // 5. Test Rappel 10 min
    function testIn10Min() {
      alert('Rappel de test configur√© pour dans 10 minutes ! Gardez l\'onglet ouvert.');
      setTimeout(() => {
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('üß™ TEST MedCoach (10min)', {
            body: 'C\'est l\'heure de votre test ! Tout fonctionne parfaitement.',
            icon: 'pilule.png',
            vibrate: [200, 100, 200]
          });
        } else {
          alert('üîî TEST : C\'est l\'heure ! (Les notifications ne sont pas autoris√©es)');
        }
      }, 10 * 60 * 1000);
    }
  </script>
</body>
</html>
