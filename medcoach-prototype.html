<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MedCoach - Prototype</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
    .container { background: white; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 500px; width: 100%; padding: 40px; }
    h1 { color: #333; margin-bottom: 10px; text-align: center; }
    .subtitle { color: #666; text-align: center; margin-bottom: 30px; font-size: 14px; }
    .form-group { margin-bottom: 20px; position: relative; }
    .form-row { display: flex; gap: 15px; }
    .form-row .form-group { flex: 1; }
    label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
    input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; font-family: inherit; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    button { width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: 600; cursor: pointer; }
    button:hover { opacity: 0.9; }
    #suggestions { list-style: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 5px 5px; max-height: 200px; overflow-y: auto; z-index: 100; display: none; }
    #suggestions.active { display: block; }
    #suggestions li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
    #suggestions li:last-child { border-bottom: none; }
    #suggestions li:hover { background-color: #f0f0f0; }
    .treatments-section { margin-top: 40px; padding-top: 30px; border-top: 2px solid #667eea; }
    .treatment-item { background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 10px; border-left: 4px solid #667eea; }
    .treatment-item h4 { color: #333; margin-bottom: 5px; }
    .treatment-item p { color: #666; font-size: 13px; margin: 3px 0; }
    .btn-remove { background: #dc3545; padding: 6px 12px; font-size: 12px; width: auto; margin-top: 10px; }
    .btn-record { background: #28a745; padding: 6px 12px; font-size: 12px; width: auto; margin-top: 10px; margin-right: 5px; }
    .features { margin-top: 30px; padding-top: 30px; border-top: 1px solid #eee; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üè• MedCoach</h1>
    <p class="subtitle">Gestion et suivi des m√©dicaments</p>
    
    <div class="form-group">
      <label>M√©dicament *</label>
      <input id="medSearch" placeholder="Doliprane..." oninput="searchMed(this.value)">
      <ul id="suggestions"></ul>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label>Quantit√© *</label>
        <input id="qte" type="number" min="1" value="1" placeholder="1">
      </div>
      <div class="form-group">
        <label>Unit√© *</label>
        <select id="unit">
          <option>comprim√©</option>
          <option>ml</option>
          <option>g√©lule</option>
          <option>sachet</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Fr√©quence (intervalle) *</label>
        <input id="freq-interval" type="number" min="1" value="1" placeholder="1">
      </div>
      <div class="form-group">
        <label>P√©riode *</label>
        <select id="freq-period">
          <option value="heure">heure</option>
          <option value="jour" selected>jour</option>
          <option value="semaine">semaine</option>
          <option value="mois">mois</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label>Moments de prise (s√©par√©s par des virgules)</label>
      <input id="freq-moments" placeholder="matin, midi, soir" value="matin">
    </div>

    <button onclick="addTreatment()">Ajouter le traitement</button>

    <div id="treatments-list" class="treatments-section" style="display: none;">
      <h2>Mes traitements</h2>
      <div id="treatment-items"></div>
    </div>

    <div class="features">
      <h3>Fonctionnalit√©s</h3>
      <ul style="margin-top: 10px; color: #666; font-size: 13px;">
        <li>‚úì Autocomplete des m√©dicaments</li>
        <li>‚úì Gestion des traitements</li>
        <li>‚úì Syst√®me de rappels programm√©s</li>
        <li>‚úì Enregistrement des prises</li>
      </ul>
    </div>
  </div>

  <script>
    let treatments = JSON.parse(localStorage.getItem('treatments')) || [];
    displayTreatments();

    async function searchMed(query) {
      if (query.length < 3) {
        document.getElementById('suggestions').innerHTML = '';
        return;
      }
      try {
        const response = await fetch(`https://api-medicaments.fr/medecines?name=${query}`);
        const data = await response.json();
        const suggestions = document.getElementById('suggestions');
        suggestions.innerHTML = '';
        data.forEach(med => {
          const li = document.createElement('li');
          li.textContent = med.name;
          li.onclick = () => selectMed(med.name);
          suggestions.appendChild(li);
        });
        suggestions.classList.add('active');
      } catch (error) {
        console.error('Erreur API:', error);
      }
    }

    function selectMed(name) {
      document.getElementById('medSearch').value = name;
      document.getElementById('suggestions').innerHTML = '';
      document.getElementById('suggestions').classList.remove('active');
      document.getElementById('qte').value = 1;
    }

    function addTreatment() {
      const med = document.getElementById('medSearch').value.trim();
      const qte = parseInt(document.getElementById('qte').value) || 1;
      const unit = document.getElementById('unit').value;
      const freqInterval = parseInt(document.getElementById('freq-interval').value) || 1;
      const freqPeriod = document.getElementById('freq-period').value;
      const freqMoments = document.getElementById('freq-moments').value.split(',').map(m => m.trim());

      if (!med) {
        alert('Veuillez entrer un m√©dicament');
        return;
      }

      const treatment = {
        id: Date.now(),
        name: med,
        qte: qte,
        unit: unit,
        freq: {
          interval: freqInterval,
          period: freqPeriod,
          moments: freqMoments
        },
        createdAt: new Date().toISOString(),
        history: []
      };

      treatments.push(treatment);
      localStorage.setItem('treatments', JSON.stringify(treatments));
      scheduleReminder(treatment);
      
      document.getElementById('medSearch').value = '';
      document.getElementById('qte').value = 1;
      document.getElementById('freq-interval').value = 1;
      document.getElementById('freq-moments').value = 'matin';
      
      displayTreatments();
    }

    function displayTreatments() {
      const container = document.getElementById('treatment-items');
      const section = document.getElementById('treatments-list');
      
      if (treatments.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      container.innerHTML = '';

      treatments.forEach(treatment => {
        const item = document.createElement('div');
        item.className = 'treatment-item';
        const nextReminder = getNextReminder(treatment);
        item.innerHTML = `
          <h4>${treatment.name}</h4>
          <p>Dosage: ${treatment.qte} ${treatment.unit}</p>
          <p>Fr√©quence: ${treatment.freq.interval}x par ${treatment.freq.period}</p>
          <p>Moments: ${treatment.freq.moments.join(', ')}</p>
          <p>Prochain rappel: ${nextReminder}</p>
          <button class="btn-record" onclick="onPris(${treatment.id})">Pris ‚úì</button>
          <button class="btn-remove" onclick="removeTreatment(${treatment.id})">Supprimer</button>
        `;
        container.appendChild(item);
      });
    }

    function scheduleReminder(treatment) {
      const now = new Date();
      const momentMap = {
        'matin': 8,
        'midi': 12,
        'apr√®s-midi': 15,
        'soir': 20,
        'nuit': 22
      };

      treatment.freq.moments.forEach(moment => {
        const hour = momentMap[moment.toLowerCase()] || 12;
        const nextTime = new Date();
        nextTime.setHours(hour, 0, 0);

        if (nextTime < now) {
          nextTime.setDate(nextTime.getDate() + 1);
        }

        const timeout = nextTime.getTime() - now.getTime();
        
        if (timeout > 0) {
          setTimeout(() => {
            console.log(`Rappel: Prendre ${treatment.name} (${treatment.qte} ${treatment.unit})`);
            console.log(`Historique: ${moment} - ${new Date().toLocaleTimeString()}`);
          }, timeout);
        }
      });
    }

    function onPris(treatmentId) {
      const treatment = treatments.find(t => t.id === treatmentId);
      if (treatment) {
        treatment.history.push({
          takenAt: new Date().toISOString(),
          moment: new Date().toLocaleTimeString()
        });
        localStorage.setItem('treatments', JSON.stringify(treatments));
        alert(`${treatment.name} enregistr√© comme pris`);
        displayTreatments();
      }
    }

    function removeTreatment(treatmentId) {
      treatments = treatments.filter(t => t.id !== treatmentId);
      localStorage.setItem('treatments', JSON.stringify(treatments));
      displayTreatments();
    }

    function getNextReminder(treatment) {
      const now = new Date();
      const momentMap = {
        'matin': 8,
        'midi': 12,
        'apr√®s-midi': 15,
        'soir': 20,
        'nuit': 22
      };

      let nextTime = null;
      treatment.freq.moments.forEach(moment => {
        const hour = momentMap[moment.toLowerCase()] || 12;
        const time = new Date();
        time.setHours(hour, 0, 0);

        if (time < now) {
          time.setDate(time.getDate() + 1);
        }

        if (!nextTime || time < nextTime) {
          nextTime = time;
        }
      });

      return nextTime ? nextTime.toLocaleString('fr-FR') : 'Pas de rappel';
    }
  </script>
</body>
</html>
